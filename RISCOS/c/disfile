/*******************************************************************
 * File:        disfile
 * Purpose:     Disassemble a single file
 * Author:      Gerph
 * Date:        16 Jun 2024
 ******************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#include "darm.h"

static darm_t d;
static darm_str_t str;

void error(char *message)
{
    printf("ERROR: %s\n", message);
    exit(1);
}


const char *disassemble_word(uint32_t word, uint32_t address, int thumb)
{
    int ok;
    static char buffer[128];

    ok = 0;
    if (thumb)
    {
        if (darm_thumb_disasm(&d, (uint16_t)word) == 0)
            ok = 1;
    }
    else
    {
        if (darm_armv7_disasm(&d, word) == 0)
            ok = 1;
    }

    if (ok &&
        darm_str2(&d, &str, 1) == 0) {

        char mnemonic[12];
        strcpy(mnemonic, str.mnemonic);
        if (strncmp(mnemonic, "svc", 3) == 0)
        {
            mnemonic[0] = 's';
            mnemonic[1] = 'w';
            mnemonic[2] = 'i';
        }

        {
            char *s;
            for (s = mnemonic; *s; s++)
            {
                *s = toupper(*s);
            }
        }

        sprintf(buffer, "%-8s%s", mnemonic, &str.total[strlen(mnemonic) + 1]);
    }
    else
    {
        sprintf(buffer, "Undefined instruction");
    }

    return buffer;
}


void disassemble_file(char *filename, int thumb)
{
    FILE *f;
    uint32_t word;
    uint32_t address;

    f = fopen(filename, "rb");
    if (f == NULL)
        error("File not found");

    address = 0;
    if (strstr(filename, ",ff8") != NULL)
        address = 0x8000;

    while (!feof(f))
    {
        int instsize = thumb ? 2 : 4;
        if (fread(&word, instsize, 1, f) != 1)
            break;

        printf("%08lx : ", address);
        if (thumb)
            printf("%04lx : ", word);
        else
            printf("%08lx : ", word);

        /* Write out the textual form of the word */
        {
            int i;
            for (i=0; i<instsize; i++)
            {
                char value = (char)(word >> (8*i)) & 0xFF;
                if (value < 32)
                    value = '.';
                else if (value == 127)
                    value = '.';
                printf("%c", value);
            }
        }
        printf(" : ");

        {
            const char *dis = disassemble_word(word, address, thumb);
            printf("%s\n", dis);
        }

        address += instsize;
    }
}


int main(int argc, char *argv[])
{
    char *filename;
    int thumb = 0;

    if (argc != 2 && argc != 3)
    {
        printf("Syntax: %s <filename>\n", argv[0]);
        exit(1);
    }

    if (strcmp(argv[1], "-thumb") == 0)
    {
        thumb = 1;
        filename = argv[2];
    }
    else
    {
        filename = argv[1];
    }

    disassemble_file(filename, thumb);
}
